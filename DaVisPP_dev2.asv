%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
% Written by: Rafael Heeb                                               %
% Contact: rafael.heeb@bristol.ac.uk                                    %
% Version: v1.240306                                                    %
% (c)2024 by RMH Aerospace                                              %
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
% CHANGELOG
% v1.210709: - Initial version
% v1.240306: - Complete revision for general use
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
%% PREAMBLE
% WARNING: Do not change unless absolutely necessary!
% ‾‾‾‾‾‾‾‾
warning('off','MATLAB:table:ModifiedAndSavedVarnames');
clear all; close all; clc; %#ok<CLALL>
cd(fileparts(matlab.desktop.editor.getActiveFilename));
addpath("Scripts\");

%% PATH TO DATA DIRECTORY
% This defines the path to the data directly. Note that this can be an
% aboslute or relative path.
file.path = "D:\Rafa_tharan\AF_Sam_sml_trial\NF_P4_20mm\";

%% DATA RELOAD
% This forces the script to reload the data into the data variable. If the
% raw data set has not changed this should be set to "0" as the script will
% automatically detect whether a data is already loaded and if necessary
% load.
data_reload = 0;

%% ANALYSIS TYPE
% 1 =   Scatter Plot: Tracking individual points which are directly pulled
%       from the .csv file.
analysis_type = 1;

%% FILE RANGE
% This array defines which files are evaluated and loaded. It can be all of
% them or only a selected few. Note that it will always load the first file
% as this is the one all subsequent data relies on. For that reason the
% first image is does not tecessary need to be specified here. Here are
% three options how this can be used
% #1 -> "all"   : By using the string "all" the script will automatically
%                 load all data
% #2 -> 1:n     : This method loads a range of data. For instance 2:15 or
%                 1:30 as long as the maximum value exists.
% #3 -> [2 3 7] : Loads a defined number of files.                                  
file.range = [2:75];

%% VARIABLE
% This is the variable which is used to in the analysis. Note that this
% must match the output from the <var_print>. 
var = "Displacement_mm_";

%% PRINT ALL AVAILABLE VARIABLES
% 1 =   This prints all variables into the command line window. This is 
%       usefull when setting up an alaysis.
% 0 =   Prevent variables to be printed into the command window.
var_print = 0;

%% SAVE FIGURE
% 1 =   Saves figure into the figure directory using the same name as the
%       original .csv file had.
% 0 =   Prevents figure from being saved. This color_stepsmight be useful when
%       testing the function as saving the figure takes a significant
%       amount of time.
fig.save = 0;

%% FONT SIZE
% This variable defines the font size of the figure. This is useful when
% exporting the figure for a report.
fig.font_size = 12;

%% COLORBAR RANGE (OPTIONAL)
% This value defines the colorbar range which is useful when comparing
% different figures with each other. This can be turned on by uncommenting
fig.colorbar_range = [0 30];

%% COLOR STEPS (OPTIONAL)
% If this value is uncommented it will define the number of color steps.
fig.color_steps = 24;

%% COLOR SCHEME (OPTIONAL)
% Check https://uk.mathworks.com/help/matlab/ref/colormap.html for more
% detail to add different color schemes. All color schemes listed in the
% link above can be used. The parula is the default scheme. Note that the
% option must exactly match the colormap syntax. If this is commented out,
% the default is autmatically chosen.
% - parula (default)
% - jet
% - ...
color_scheme = "jet";

%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%
%% DEFINE FUNCTIONS
R = @(a) [cosd(a) -sind(a); sind(a) cosd(a)];
mesh_size = 100;

%% INDEX DATA DIRECTORY
file.meta = dir(sprintf("%s*.csv",file.path));
file.num = size(file.meta,1);

%% PREPARE DATA
% Load all files
if strcmp(file.range,"all")
    file.range = 1:file.num;
end
% Load the legend variables
file_name = file.meta(1).name;
dat = readtable(sprintf("%s%s",file.path,file_name),VariableNamingRule="preserve");
legend_variables.raw = dat.Properties.VariableNames;

%% CHECK INPUTS
% Check file range. The maximum value cannot be larger than the number of
% .csv file present it the data directly.
error_num = 0;
if any(file.range > file.num)
    warning("The maximum value in <file_range> cannot be higher than the " + ...
        "number of files (%0.f) defined in <file_range> in the data " + ...
        "directory.",file.num);
    error_num = error_num + 1;
end
% Check whether the variable defined in contained in the list of variables
% within the data set.
dat = readtable(sprintf("%s%s",file.path,file_name),VariableNamingRule="modify");
variables = dat.Properties.VariableNames;
if ~any(var == variables)
    warning("The Variable <%s> defined in <var> is not contained in the raw data", ...
        var);
    error_num = error_num + 1;
end
% Run error command
if error_num == 1
    error("There is an input error. Look at the warnings before continuing!");
elseif error_num > 1
    error("There are %0.f input errors. Look at the warnings before continuing!", ...
        error_num);
end
% Check whether DaVisPP_data.mat is present. If it is then load the data
% .mat file and check whether the file range matches. If it does not or if
% the DaVisPP_data.mat file is not present reload all the data.
if ~isfile(sprintf("%s%s",file.path,"DaVisPP_data.mat"))
    data_reload = 1;
else
    old = load(sprintf("%s%s",file.path,"DaVisPP_data.mat"),"file");
    file = nameLoad(file);
    if ~isequal(old.file.name,file.name)
        data_reload = 1;
    else
        load(sprintf("%s%s",file.path,"DaVisPP_data.mat"),"data");
    end
end

%% ERASE UNUSED DATA
clear dat file_name error_num old;

%% LOAD RAW DATA INTO THE
if data_reload == 1
    [data,file] = dataLoad(file);
end

%% MAIN SCRIPT

Z_displacement_max = nan(1,file.num);
Y_displacement_max = nan(1,file.num);
Eyy_S_max = nan(1,file.num);

zi = 1;
for i = file.range
    name = file.name(i);
    fig.name = sprintf("%s_%s",file.name(i),var);
    if zi == 1
        variables = data.(name).Properties.VariableNames;
        legend_variables.c = legend_variables.raw(find((var == variables) == 1));
        legend_variables.x = legend_variables.raw(1);
        legend_variables.y = legend_variables.raw(2);
        legend_variables.z = legend_variables.raw(3);
    end
    if var_print == 1
        if zi == 1
            fprintf("* * * * * * * * * * * * *\n" + ...
                    "*  Variables  Availabe  *\n" + ...
                    "* * * * * * * * * * * * *\n\n");
            for j = 1:size(variables,2)
                fprintf('%s\n',cell2mat(variables(j)));
            end
            fprintf("\n" + ...
                    "* * * * * * * * * * *\n" + ...
                    "*  Directory Stats  *\n" + ...
                    "* * * * * * * * * * *\n\n");
            fprintf("There are a total of %0.f .csv files in the <%s> directory\n", ...
                size(file.name,1),file.path);
        end
    end

    %% Data Porcessing

    x = data.(name).x_mm_;     y = data.(name).y_mm_;     z = data.(name).z_mm_;     c = data.(name).(var);

    z_min_0 = min(z);     z = z - z_min_0;
    x_min_0 = min(x);     x = x - x_min_0;
    y_min_0 = min(y);     y = y - y_min_0;

    dx = data.(name).X_displacement_mm_;
    dy = data.(name).Y_displacement_mm_;
    dz = data.(name).Z_displacement_mm_;
    
    if i > 1
        x = x + dx;
        y = y + dy;
        z = z + dz;
    end

    x_min = min(x);    x_max = max(x);
    y_min = min(y);    y_max = max(y);

    xlin = linspace(x_min,x_max,mesh_size);
    ylin = linspace(y_min,y_max,mesh_size);

    [X,Y] = meshgrid(xlin,ylin);

    fz = scatteredInterpolant(x,y,z);
    Z = fz(X,Y);


    %% PRINT SCATTER FIGURE
    % Create Table contating the data for scatter figure
    if analysis_type == 1
        export_data = table(x,y,z,c);
        
        % Create Figure
        F = figure(zi);
        setLaTeX(fig.font_size);
        scatter3(export_data,"x","y","z","filled","ColorVariable","c")
        % Colorbar
        if ~exist("color_scheme","var")
            color_scheme = "parula";
        end
        cmap = str2func(color_scheme);
        if exist("fig.color_steps","var")
            colormap(F,cmap(fig.color_steps));
        else
            colormap(F,cmap());
        end
        if exist("fig.colorbar_range","var")
            caxis(fig.colorbar_range)
        end
        col = colorbar;
        col.Label.String = legend_variables.c;
        col.Label.Interpreter = 'latex';
        col.TickLabelInterpreter = 'latex';
        axis equal;
        % Labels
        xlabel(legend_variables.x)
        ylabel(legend_variables.y)
        zlabel(legend_variables.z)
        % Print figure
        if fig.save == 1
            printFigure(F,fig.name)
        end
    elseif analysis_type == 2
        %% PRINT 2D PLOT
        F = figure(zi);
        hold on;
        setLaTeX(fig.font_size);
        scatter(x,y);
        axis equal;
        % Print figure
        if fig.save == 1
            printFigure(F,fig.name)
        end
    end
    zi = zi + 1;
end